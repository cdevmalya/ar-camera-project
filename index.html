<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Name of your awesome camera app -->
    <title>AR Camera App</title>

    <script type="text/javascript" src="cv.js"></script> 
    <script type="text/javascript" src="aruco.js"></script> 
    <!-- Link to your main style sheet-->
    <link rel="stylesheet" href="style.css">
    <script>
        var my_video, my_canvas, context, image, imageData, detector;
          function onLoad() {
              my_video = document.getElementById("video");
              my_canvas = document.getElementById("canvas");
              context = my_canvas.getContext("2d");

              image = new Image();
              image.src = "https://picsum.photos/id/237/200/300";
              image.crossOrigin = "Anonymous";

              my_canvas.style.width = window.innerWidth + "px";
              my_canvas.style.height = window.innerHeight + "px";
              my_canvas.width = parseInt(my_canvas.style.width);
              my_canvas.height = parseInt(my_canvas.style.height);
  
              // Set constraints for the video stream
              var constraints = { video: { facingMode: "environment" }, audio: false };
              function cameraStart() {
                  navigator.mediaDevices
                      .getUserMedia(constraints)
                      .then(function(stream) {
                      track = stream.getTracks()[0];
                      my_video.srcObject = stream;
                  })
                  .catch(function(error) {
                      console.error("Oops. Something is broken.", error);
                  });
              }
              cameraStart();
              detector = new AR.Detector();
              
              requestAnimationFrame(tick);
            //   setInterval(() => requestAnimationFrame(tick), 50);
          }
  
          function tick(){
              requestAnimationFrame(tick);
            //   setInterval(() => requestAnimationFrame(tick), 50); 
              if (my_video.readyState === my_video.HAVE_ENOUGH_DATA){
                snapshot();
                // context.strokeRect(20,20, 100, 100);

                var markers = detector.detect(imageData);
                
                drawCorners(markers);
                // drawImg(markers);
                //   drawId(markers);
              }
          }
          
          function snapshot(){
              context.drawImage(my_video, 0, 0, my_canvas.width, my_canvas.height);
              imageData = context.getImageData(0, 0, my_canvas.width, my_canvas.height);
          }
  
          function drawCorners(markers){
              let corners, corner, i, j;

              context.strokeRect(20,20, 150, 100);
      
              context.lineWidth = 3;
  
              for (i = 0; i !== markers.length; ++ i){
                  corners = markers[i].corners;
          
                  context.strokeStyle = "red";
                  context.beginPath();
              
              for (j = 0; j !== corners.length; ++ j){
              corner = corners[j];
              context.moveTo(corner.x, corner.y);
              corner = corners[(j + 1) % corners.length];
              context.lineTo(corner.x, corner.y);
              }
  
              context.stroke();
              context.closePath();
              
              context.strokeStyle = "green";
              context.strokeRect(corners[0].x - 2, corners[0].y - 2, 40, 40);
              context.drawImage(image,corners[0].x - 2, corners[0].y - 2);
            }
          }
  
          function drawImg(markers){
            context.drawImage(image,10,10);
          }
          window.onload = onLoad;
      </script>

</head>

<body>
    <!-- Camera view -->
    <video id="video" autoplay playsinline></video>
    <!-- <video id="video" autoplay="true" style="display:none;" ></video> -->
    <!-- Camera sensor -->
    <!-- <canvas id="canvas" style="width:640px; height:480px;"></canvas> -->
    <canvas id="canvas"></canvas>
</body>
</html>
